<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>JS Raycast</title>
    <style type="text/css">
        canvas {
            border: 1px solid rgb(0, 0, 0);
        }
    </style>
    <script type="application/javascript">
        let grid = [
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,1,0,0,0,0,0,0,2,2,2,2,2,2,0,0,0,0,1,0,0,0,0,0,0],
                    [0,0,1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,9,0,0,0,0,1,1,0,2,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,1,1,0,2,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,2,2,2,2,2,2,2,0,0,0,0,1,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
                    [0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
                ];

        let gridSize = 32;
        let cameraPosition = {};
        let fov = 60;
        let angle = -35;
        let distance = 10;
        let raysCount = 300;
        let rayStep = 1;
        

        function drawGrid(ctx)
        {
            for(let y=0; y< grid.length; y++)
            {
                for(let x=0; x <grid[y].length; x++)
                {
                    if(grid[y][x] === 1)
                    {
                        ctx.fillStyle = 'blue';
                        ctx.fillRect(x*gridSize, y*gridSize, gridSize, gridSize);  
                    }
                    else if(grid[y][x] === 2)
                    {
                        ctx.fillStyle = 'red';
                        ctx.fillRect(x*gridSize, y*gridSize, gridSize, gridSize);  
                    }else if(grid[y][x] === 9)
                    {
                        cameraPosition.X = x;
                        cameraPosition.Y = y;
                    }
                    
                    ctx.strokeStyle = 'lightgrey';
                    ctx.strokeRect(x*gridSize, y*gridSize, gridSize, gridSize);   
                }
            }
        }

        function drawCamera(cameraPosition, ctx)
        {
            let xPosition = cameraPosition.X*gridSize + gridSize/2;
            let yPosition = cameraPosition.Y*gridSize + gridSize/2;
            let rayLength = distance * gridSize;
            let point = {};            

            for (let i = -fov / 2; i < fov / 2; i += fov / raysCount) {
                for (let j = rayStep; j < rayLength; j += rayStep) {
                    point = rotatePoint(xPosition, yPosition, xPosition + j, yPosition, Math.PI * (i - angle) / 180);
                    
                    if(checkRayCollision(point.X, point.Y)) {
                        break;
                    }
                }
                
                ctx.strokeStyle = 'black';
                ctx.beginPath();
                ctx.moveTo(xPosition, yPosition);
                ctx.lineTo(point.X, point.Y);
                ctx.stroke();
            }
            
            ctx.fillStyle = "black"
            ctx.beginPath();
            ctx.arc(xPosition, yPosition, gridSize/2 - 1, 0, 2 * Math.PI);
            ctx.fill();
        }

        function rotatePoint(startX, startY, endX, endY, angle) {
            let point = {}
            point.X = startX + (endX - startX) * Math.cos(angle) - (endY - startY) * Math.sin(angle);
            point.Y = startY + (endX - startX) * Math.sin(angle) + (endY - startY) * Math.cos(angle);
            return point;
        }

        function getCellNumberFromCoordinate(x, y) {
            let point = {};
            point.X = Math.floor(x/gridSize);
            point.Y = Math.floor(y/gridSize);
            return point;
        }

        function checkRayCollision(x, y)
        {
            currentCell= getCellNumberFromCoordinate(x, y);

            if(currentCell.X < 0 || currentCell.Y < 0) {
                return true;
            }
            if(currentCell.Y > grid.length-1) {
                return true;
            }

            if(currentCell.X > grid[currentCell.Y].length-1) {
                return true;
            }

            if(grid[currentCell.Y][currentCell.X] > 00 && grid[currentCell.Y][currentCell.X] < 9)
            {
                return true;
            }

            return false;
        }

        function draw() {
            let canvas = document.getElementById("graph");
            if (canvas.getContext) {
				/** @type {CanvasRenderingContext2D}*/
                var ctx = canvas.getContext("2d");
                let width = 800;
                let height = 600;
                ctx.clearRect(0, 0, width, height);
                
                drawGrid(ctx);      
                drawCamera(cameraPosition, ctx);        
            }
        }

    </script>
</head>

<body onload="draw();" onkeypress="KeyHandle(event)">
    <canvas id="graph" width="800" height="600">
        <p>Fallback content</p>
    </canvas>
</body>

</html>